<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ - Бонусная система ПЕРЕЦ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #1d2733;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            padding: 10px;
            background: #1d2733;
        }
        
        .active {
            display: flex !important;
        }
        
        .header {
            background: #293a53;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            border: 2px solid #000;
        }
        
        .login-form {
            background: #1d2733;
            padding: 20px;
            border: 2px solid #293a53;
            margin: 20px auto;
            width: 90%;
            max-width: 400px;
        }
        
        .user-list {
            margin: 10px 0;
        }
        
        .user-button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            background: #293a53;
            color: #fff;
            border: 2px solid #000;
            cursor: pointer;
            margin: 5px 0;
            text-align: center;
        }
        
        .user-button:active {
            background: #3a4b63;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            margin: 10px 0;
            border: 2px solid #293a53;
            background: #1d2733;
            color: #fff;
            text-align: center;
        }
        
        .password-display {
            font-size: 24px;
            letter-spacing: 5px;
            text-align: center;
            margin: 10px 0;
            min-height: 40px;
            color: #fff;
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        
        .keypad-button {
            padding: 20px;
            font-size: 18px;
            background: #293a53;
            color: #fff;
            border: 2px solid #000;
            cursor: pointer;
        }
        
        .keypad-button:active {
            background: #3a4b63;
        }
        
        .action-button {
            background: #293a53;
            color: #fff;
            border: 2px solid #000;
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }
        
        .action-button:active {
            background: #3a4b63;
        }
        
        .green-button {
            background: #00aa00;
        }
        
        .red-button {
            background: #aa0000;
        }
        
        .status-bar {
            background: #293a53;
            color: #fff;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #000;
            margin-bottom: 10px;
        }
        
        .main-button {
            background: #293a53;
            color: #fff;
            border: 2px solid #000;
            padding: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px 0;
            text-align: left;
        }
        
        .main-button:active {
            background: #3a4b63;
        }
        
        .input-field {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #293a53;
            background: #1d2733;
            color: #fff;
            margin: 10px 0;
        }
        
        .button-row {
            display: flex;
            gap: 5px;
            margin: 5px 0;
        }
        
        .number-button {
            flex: 1;
            background: #293a53;
            color: #fff;
            border: 2px solid #000;
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .number-button:active {
            background: #3a4b63;
        }
        
        .user-info {
            background: #293a53;
            padding: 15px;
            border: 2px solid #000;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .balance-display {
            font-size: 18px;
            color: #fff;
            font-weight: bold;
            margin: 10px 0;
            background: #1d2733;
            padding: 10px;
            border: 1px solid #293a53;
        }
        
        .calculator-display {
            background: #293a53;
            padding: 15px;
            border: 2px solid #000;
            margin: 10px 0;
        }
        
        .bonus-result {
            font-size: 16px;
            color: #fff;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            background: #1d2733;
            padding: 10px;
            border: 1px solid #293a53;
        }
        
        .info-text {
            font-size: 12px;
            color: #fff;
            margin: 5px 0;
        }
        
        .history-list {
            background: #1d2733;
            border: 2px solid #293a53;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #293a53;
            font-size: 12px;
            color: #fff;
        }
        
        .developer-section {
            background: #293a53;
            padding: 15px;
            border: 2px solid #000;
            margin: 10px 0;
        }
        
        .special-image {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1d2733;
        }
        
        .special-image img {
            max-width: 100%;
            max-height: 80%;
            object-fit: contain;
        }
        
        .countdown-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1d2733;
            text-align: center;
            padding: 20px;
        }
        
        .countdown-timer {
            font-size: 48px;
            color: #00ff00;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .countdown-text {
            font-size: 24px;
            margin: 20px 0;
        }

        .hidden-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }
    </style>
</head>
<body>
    <!-- Скрытое поле для ввода с клавиатуры -->
    <input type="text" class="hidden-input" id="keyboardInput" placeholder="Введите штрихкод">

    <!-- ЭКРАН ВВОДА ПАРОЛЯ -->
    <div class="screen active" id="loginScreen">
        <div class="header">вход в систему</div>
        
        <div class="login-form">
            <div class="info-text">пользователь: <span id="currentUser">Елена</span></div>
            <div class="info-text">введите пароль:</div>
            
            <div class="password-display" id="passwordDisplay">*</div>
            <input type="hidden" id="passwordInput">
            
            <div class="keypad">
                <button class="keypad-button" onclick="addPasswordNumber('1')">1</button>
                <button class="keypad-button" onclick="addPasswordNumber('2')">2</button>
                <button class="keypad-button" onclick="addPasswordNumber('3')">3</button>
                <button class="keypad-button" onclick="addPasswordNumber('4')">4</button>
                <button class="keypad-button" onclick="addPasswordNumber('5')">5</button>
                <button class="keypad-button" onclick="addPasswordNumber('6')">6</button>
                <button class="keypad-button" onclick="addPasswordNumber('7')">7</button>
                <button class="keypad-button" onclick="addPasswordNumber('8')">8</button>
                <button class="keypad-button" onclick="addPasswordNumber('9')">9</button>
                <button class="keypad-button red-button" onclick="clearPassword()">очистить</button>
                <button class="keypad-button" onclick="addPasswordNumber('0')">0</button>
                <button class="keypad-button red-button" onclick="deleteLastPassword()">удалить</button>
            </div>
            
            <button class="action-button green-button" onclick="checkPassword()">вход</button>
            <button class="action-button" onclick="showUserSelect()">другой юзер</button>
            
            <div class="info-text" id="loginError" style="color:#ff4444; display:none;">неверный пароль!</div>
        </div>
    </div>

    <!-- ЭКРАН ВЫБОРА ПОЛЬЗОВАТЕЛЯ -->
    <div class="screen" id="userSelectScreen">
        <div class="header">бонусная система "перец"</div>
        
        <div class="login-form">
            <div class="info-text">выберите пользователя:</div>
            
            <div class="user-list">
                <button class="user-button" onclick="selectUser('Елена')">Елена</button>
                <button class="user-button" onclick="selectUser('developer')">developer</button>
            </div>
            
            <button class="action-button" onclick="showLoginScreen()">назад</button>
        </div>
    </div>

    <!-- ГЛАВНЫЙ ЭКРАН ЕЛЕНЫ -->
    <div class="screen" id="mainScreen">
        <div class="status-bar">кассир: <span id="currentUserName">Елена</span> | бонусная система "перец"</div>
        
        <button class="main-button" onclick="startBarcodeScan()">
            сканировать штрихкод
        </button>
        
        <button class="main-button" onclick="showManualInput()">
            ручной ввод штрихкода
        </button>
        
        <button class="main-button" onclick="showScanHistory()">
            история сканирования
        </button>
        
        <button class="main-button red-button" onclick="logout()">
            выход
        </button>
    </div>

    <!-- ЭКРАН РУЧНОГО ВВОДА ШТРИХКОДА -->
    <div class="screen" id="manualInputScreen">
        <div class="status-bar">кассир: <span id="manualInputUser">Елена</span> | ручной ввод штрихкода</div>
        
        <div class="password-display" id="barcodeDisplay"></div>
        <input type="hidden" id="barcodeInput">
        
        <div class="info-text">введите 12 цифр штрихкода с клавиатуры или используйте кнопки ниже</div>
        
        <div class="keypad">
            <button class="keypad-button" onclick="addBarcodeNumber('1')">1</button>
            <button class="keypad-button" onclick="addBarcodeNumber('2')">2</button>
            <button class="keypad-button" onclick="addBarcodeNumber('3')">3</button>
            <button class="keypad-button" onclick="addBarcodeNumber('4')">4</button>
            <button class="keypad-button" onclick="addBarcodeNumber('5')">5</button>
            <button class="keypad-button" onclick="addBarcodeNumber('6')">6</button>
            <button class="keypad-button" onclick="addBarcodeNumber('7')">7</button>
            <button class="keypad-button" onclick="addBarcodeNumber('8')">8</button>
            <button class="keypad-button" onclick="addBarcodeNumber('9')">9</button>
            <button class="keypad-button red-button" onclick="clearBarcode()">очистить</button>
            <button class="keypad-button" onclick="addBarcodeNumber('0')">0</button>
            <button class="keypad-button red-button" onclick="deleteLastBarcode()">удалить</button>
        </div>
        
        <button class="action-button green-button" onclick="findUserByBarcode()">найти клиента</button>
        <button class="action-button" onclick="showMainScreen()">назад</button>
    </div>

    <!-- ЭКРАН ИНФОРМАЦИИ О КЛИЕНТЕ -->
    <div class="screen" id="userInfoScreen">
        <div class="status-bar">кассир: <span id="userInfoUser">Елена</span> | начисление бонусов</div>
        
        <div class="user-info">
            <div>клиент: <span id="userName">-</span></div>
            <div class="balance-display">баланс: <span id="userBalance">0</span> бонусов</div>
            <div>штрихкод: <span id="userBarcode">-</span></div>
        </div>

        <div class="calculator-display">
            <div>сумма покупки (руб):</div>
            <div class="password-display" id="purchaseDisplay">0</div>
            <input type="hidden" id="purchaseAmount" value="0">
            
            <div class="keypad">
                <button class="keypad-button" onclick="addPurchaseNumber('1')">1</button>
                <button class="keypad-button" onclick="addPurchaseNumber('2')">2</button>
                <button class="keypad-button" onclick="addPurchaseNumber('3')">3</button>
                <button class="keypad-button" onclick="addPurchaseNumber('4')">4</button>
                <button class="keypad-button" onclick="addPurchaseNumber('5')">5</button>
                <button class="keypad-button" onclick="addPurchaseNumber('6')">6</button>
                <button class="keypad-button" onclick="addPurchaseNumber('7')">7</button>
                <button class="keypad-button" onclick="addPurchaseNumber('8')">8</button>
                <button class="keypad-button" onclick="addPurchaseNumber('9')">9</button>
                <button class="keypad-button red-button" onclick="clearPurchase()">очистить</button>
                <button class="keypad-button" onclick="addPurchaseNumber('0')">0</button>
                <button class="keypad-button" onclick="addPurchaseNumber('.')">.</button>
            </div>
            
            <div class="bonus-result">
                бонусов к начислению: <span id="bonusCalculation">0</span>
            </div>
        </div>

        <div class="calculator-display">
            <div>прямое начисление бонусов:</div>
            <div class="password-display" id="directBonusDisplay">0</div>
            <input type="hidden" id="directBonusInput" value="0">
            
            <div class="keypad">
                <button class="keypad-button" onclick="addDirectBonusNumber('1')">1</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('2')">2</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('3')">3</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('4')">4</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('5')">5</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('6')">6</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('7')">7</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('8')">8</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('9')">9</button>
                <button class="keypad-button red-button" onclick="clearDirectBonus()">очистить</button>
                <button class="keypad-button" onclick="addDirectBonusNumber('0')">0</button>
                <button class="keypad-button red-button" onclick="deleteLastDirectBonus()">удалить</button>
            </div>
        </div>

        <button class="action-button green-button" onclick="addBonusesToUser()">начислить бонусы</button>
        <button class="action-button" onclick="showMainScreen()">новый клиент</button>
    </div>

    <!-- ЭКРАН ИСТОРИИ СКАНИРОВАНИЯ -->
    <div class="screen" id="historyScreen">
        <div class="status-bar">история сканирования</div>
        
        <div class="developer-section">
            <div class="info-text">последние операции:</div>
            <div class="history-list" id="scanHistoryList">
                <!-- История будет загружена здесь -->
            </div>
        </div>
        
        <button class="action-button" onclick="showMainScreen()">назад</button>
    </div>

    <!-- ЭКРАН СПЕЦИАЛЬНОГО ШТРИХКОДА -->
    <div class="screen" id="specialBarcodeScreen">
        <div class="special-image">
            <img src="1.png" alt="Специальное изображение" onerror="this.style.display='none'">
            <button class="action-button" onclick="showMainScreen()" style="margin-top: 20px;">хорошо</button>
        </div>
    </div>

    <!-- ЭКРАН ОБРАТНОГО ОТСЧЕТА -->
    <div class="screen" id="countdownScreen">
        <div class="countdown-screen">
            <div class="countdown-text">бонусы клиенту начислены, возвращаемся на главный экран</div>
            <div class="countdown-timer" id="countdownTimer">4</div>
            <button class="action-button red-button" onclick="cancelCountdown()">отменить начисление</button>
        </div>
    </div>

    <!-- ЭКРАН РАЗРАБОТЧИКА -->
    <div class="screen" id="developerScreen">
        <div class="status-bar">developer mode | бонусная система "перец"</div>
        
        <div class="developer-section">
            <div class="info-text">история сканирования:</div>
            <div class="history-list" id="devHistoryList">
                <!-- История будет загружена здесь -->
            </div>
        </div>
        
        <div class="developer-section">
            <div class="info-text">база данных пользователей:</div>
            <div class="history-list" id="userDatabaseList">
                <!-- База данных будет загружена здесь -->
            </div>
        </div>
        
        <div class="developer-section">
            <div class="info-text">настройки системы:</div>
            <button class="main-button" onclick="resetSystem()">сброс системы</button>
            <button class="main-button" onclick="exportData()">экспорт данных</button>
        </div>
        
        <button class="action-button" onclick="logout()">выход</button>
    </div>

    <script>
        let currentUser = null;
        let currentUserName = 'Елена';
        let scanHistory = JSON.parse(localStorage.getItem('scanHistory')) || [];
        let countdownInterval = null;
        let keyboardBuffer = '';
        let keyboardTimeout = null;
        
        // Демо-база данных пользователей
        const userDatabase = {
            "123456789012": { username: "Иванов Петр", balance: 150 },
            "987654321098": { username: "Сидорова Мария", balance: 75 },
            "111222333444": { username: "Петров Алексей", balance: 200 },
            "555666777888": { username: "Козлова Анна", balance: 300 },
            "999888777666": { username: "Смирнов Дмитрий", balance: 125 }
        };
        
        // Управление пользователями
        function selectUser(user) {
            currentUserName = user;
            document.getElementById('currentUser').textContent = user;
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordDisplay').textContent = '*';
            document.getElementById('loginError').style.display = 'none';
            showScreen('loginScreen');
        }
        
        function showUserSelect() {
            showScreen('userSelectScreen');
        }
        
        function showLoginScreen() {
            showScreen('loginScreen');
        }
        
        // Управление паролем
        function addPasswordNumber(num) {
            const input = document.getElementById('passwordInput');
            if (input.value.length < 8) {
                input.value += num;
                document.getElementById('passwordDisplay').textContent = '*'.repeat(input.value.length);
            }
        }
        
        function clearPassword() {
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordDisplay').textContent = '*';
        }
        
        function deleteLastPassword() {
            const input = document.getElementById('passwordInput');
            input.value = input.value.slice(0, -1);
            document.getElementById('passwordDisplay').textContent = '*'.repeat(input.value.length);
        }
        
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            let isValid = false;
            
            if (currentUserName === 'Елена' && password === '5901') {
                isValid = true;
                showMainScreen();
            } else if (currentUserName === 'developer' && password === '42385902') {
                isValid = true;
                showDeveloperScreen();
            }
            
            if (!isValid) {
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        // Переключение экранов
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Обновляем отображение текущего пользователя
            if (currentUserName) {
                const userElements = document.querySelectorAll('#currentUserName, #manualInputUser, #userInfoUser');
                userElements.forEach(element => {
                    if (element) element.textContent = currentUserName;
                });
            }
            
            // Фокусируем скрытое поле для ввода с клавиатуры на нужных экранах
            const keyboardInput = document.getElementById('keyboardInput');
            if (screenId === 'manualInputScreen' || screenId === 'userInfoScreen') {
                setTimeout(() => {
                    keyboardInput.focus();
                    keyboardInput.value = '';
                    keyboardBuffer = '';
                }, 100);
            } else {
                keyboardInput.blur();
            }
        }
        
        function showMainScreen() {
            currentUser = null;
            showScreen('mainScreen');
        }
        
        function logout() {
            currentUser = null;
            currentUserName = 'Елена';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordDisplay').textContent = '*';
            document.getElementById('loginError').style.display = 'none';
            showScreen('loginScreen');
        }
        
        // Ручной ввод штрихкода
        function startBarcodeScan() {
            showScreen('manualInputScreen');
            clearBarcode();
        }
        
        function showManualInput() {
            showScreen('manualInputScreen');
            clearBarcode();
        }
        
        function addBarcodeNumber(num) {
            const input = document.getElementById('barcodeInput');
            if (input.value.length < 12) {
                input.value += num;
                document.getElementById('barcodeDisplay').textContent = input.value;
                
                // Автоматический поиск при вводе 12 цифр
                if (input.value.length === 12) {
                    setTimeout(() => {
                        findUserByBarcode();
                    }, 100);
                }
            }
        }
        
        function clearBarcode() {
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeDisplay').textContent = '';
            keyboardBuffer = '';
        }
        
        function deleteLastBarcode() {
            const input = document.getElementById('barcodeInput');
            input.value = input.value.slice(0, -1);
            document.getElementById('barcodeDisplay').textContent = input.value;
        }
        
        // Обработка ввода с клавиатуры
        function setupKeyboardListener() {
            const keyboardInput = document.getElementById('keyboardInput');
            
            keyboardInput.addEventListener('input', function(e) {
                const value = this.value;
                
                // Если на экране ручного ввода штрихкода
                if (document.getElementById('manualInputScreen').classList.contains('active')) {
                    // Обрабатываем только цифры
                    const digits = value.replace(/\D/g, '');
                    
                    if (digits.length > 0) {
                        document.getElementById('barcodeInput').value = digits.slice(0, 12);
                        document.getElementById('barcodeDisplay').textContent = digits.slice(0, 12);
                        
                        // Автоматический поиск при вводе 12 цифр
                        if (digits.length >= 12) {
                            setTimeout(() => {
                                findUserByBarcode();
                            }, 100);
                        }
                    }
                    
                    this.value = '';
                }
                
                // Если на экране информации о клиенте - обрабатываем ввод для суммы покупки и бонусов
                if (document.getElementById('userInfoScreen').classList.contains('active')) {
                    // Здесь можно добавить обработку для других полей ввода если нужно
                    this.value = '';
                }
            });
            
            // Обработка специальных клавиш
            keyboardInput.addEventListener('keydown', function(e) {
                // Enter - поиск клиента на экране ручного ввода
                if (e.key === 'Enter' && document.getElementById('manualInputScreen').classList.contains('active')) {
                    e.preventDefault();
                    findUserByBarcode();
                }
                
                // Escape - назад
                if (e.key === 'Escape') {
                    e.preventDefault();
                    if (document.getElementById('manualInputScreen').classList.contains('active') || 
                        document.getElementById('userInfoScreen').classList.contains('active')) {
                        showMainScreen();
                    }
                }
            });
        }
        
        // Поиск пользователя по штрихкоду
        function findUserByBarcode() {
            const barcode = document.getElementById('barcodeInput').value;
            
            if (barcode.length !== 12) {
                alert('ошибка: штрихкод должен содержать 12 цифр!');
                return;
            }
            
            // Проверка специального штрихкода
            if (barcode === 'EAAA100000044') {
                showScreen('specialBarcodeScreen');
                return;
            }
            
            // Добавляем в историю
            const scanRecord = {
                barcode: barcode,
                timestamp: new Date().toLocaleString(),
                user: currentUserName
            };
            scanHistory.unshift(scanRecord);
            localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
            
            if (userDatabase[barcode]) {
                currentUser = {
                    barcode: barcode,
                    username: userDatabase[barcode].username,
                    balance: userDatabase[barcode].balance
                };
                
                showUserInfoScreen();
            } else {
                alert('клиент с таким штрихкодом не найден в системе!');
            }
        }
        
        // Показ информации о пользователе
        function showUserInfoScreen() {
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userBalance').textContent = currentUser.balance;
            document.getElementById('userBarcode').textContent = currentUser.barcode;
            
            clearPurchase();
            clearDirectBonus();
            updateBonusCalculation();
            
            showScreen('userInfoScreen');
        }
        
        // Управление суммой покупки
        function addPurchaseNumber(num) {
            const input = document.getElementById('purchaseAmount');
            let value = input.value;
            
            if (value === '0') value = '';
            if (num === '.' && value.includes('.')) return;
            
            value += num;
            input.value = value;
            document.getElementById('purchaseDisplay').textContent = value;
            updateBonusCalculation();
        }
        
        function clearPurchase() {
            document.getElementById('purchaseAmount').value = '0';
            document.getElementById('purchaseDisplay').textContent = '0';
            updateBonusCalculation();
        }
        
        function updateBonusCalculation() {
            const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
            // 10 бонусов = 1 рубль (1 бонус = 0.1 рубля)
            const bonuses = Math.floor(amount * 10);
            document.getElementById('bonusCalculation').textContent = bonuses;
        }
        
        // Прямое начисление бонусов (цифровая клавиатура)
        function addDirectBonusNumber(num) {
            const input = document.getElementById('directBonusInput');
            let value = input.value;
            
            if (value === '0') value = '';
            
            value += num;
            input.value = value;
            document.getElementById('directBonusDisplay').textContent = value;
        }
        
        function clearDirectBonus() {
            document.getElementById('directBonusInput').value = '0';
            document.getElementById('directBonusDisplay').textContent = '0';
        }
        
        function deleteLastDirectBonus() {
            const input = document.getElementById('directBonusInput');
            let value = input.value;
            value = value.slice(0, -1);
            if (value === '') value = '0';
            input.value = value;
            document.getElementById('directBonusDisplay').textContent = value;
        }
        
        // Начисление бонусов
        function addBonusesToUser() {
            const purchaseAmount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
            const directBonus = parseInt(document.getElementById('directBonusInput').value) || 0;
            
            let bonusesToAdd = directBonus;
            
            if (purchaseAmount > 0) {
                // 10 бонусов = 1 рубль
                bonusesToAdd += Math.floor(purchaseAmount * 10);
            }
            
            if (bonusesToAdd <= 0) {
                alert('ошибка: введите количество бонусов для начисления!');
                return;
            }
            
            currentUser.balance += bonusesToAdd;
            userDatabase[currentUser.barcode].balance = currentUser.balance;
            
            // Показываем экран обратного отсчета
            startCountdown();
        }
        
        // Обратный отсчет
        function startCountdown() {
            let seconds = 4;
            showScreen('countdownScreen');
            document.getElementById('countdownTimer').textContent = seconds;
            
            countdownInterval = setInterval(() => {
                seconds--;
                document.getElementById('countdownTimer').textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    showMainScreen();
                    clearPurchase();
                    clearDirectBonus();
                }
            }, 1000);
        }
        
        function cancelCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // Откатываем начисление бонусов
            const purchaseAmount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
            const directBonus = parseInt(document.getElementById('directBonusInput').value) || 0;
            
            let bonusesToAdd = directBonus;
            if (purchaseAmount > 0) {
                bonusesToAdd += Math.floor(purchaseAmount * 10);
            }
            
            currentUser.balance -= bonusesToAdd;
            userDatabase[currentUser.barcode].balance = currentUser.balance;
            
            document.getElementById('userBalance').textContent = currentUser.balance;
            showUserInfoScreen();
        }
        
        // История сканирования
        function showScanHistory() {
            showScreen('historyScreen');
            loadScanHistory();
        }
        
        function loadScanHistory() {
            const historyList = document.getElementById('scanHistoryList');
            historyList.innerHTML = '';
            
            scanHistory.slice(0, 20).forEach(record => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = `${record.timestamp} - ${record.barcode} (${record.user})`;
                historyList.appendChild(item);
            });
        }
        
        // Экран разработчика
        function showDeveloperScreen() {
            showScreen('developerScreen');
            loadDevHistory();
            loadUserDatabase();
        }
        
        function loadDevHistory() {
            const historyList = document.getElementById('devHistoryList');
            historyList.innerHTML = '';
            
            scanHistory.forEach(record => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = `${record.timestamp} - ${record.barcode} (${record.user})`;
                historyList.appendChild(item);
            });
        }
        
        function loadUserDatabase() {
            const dbList = document.getElementById('userDatabaseList');
            dbList.innerHTML = '';
            
            Object.keys(userDatabase).forEach(barcode => {
                const user = userDatabase[barcode];
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = `${barcode} - ${user.username} - ${user.balance} бонусов`;
                dbList.appendChild(item);
            });
        }
        
        function resetSystem() {
            if (confirm('сбросить систему?')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        function exportData() {
            const data = {
                users: userDatabase,
                history: scanHistory
            };
            alert('данные экспортированы в консоль');
            console.log('Export Data:', data);
        }
        
        // Инициализация
        showScreen('loginScreen');
        setupKeyboardListener();
    </script>
</body>
</html>
